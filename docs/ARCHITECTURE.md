# ARCHITECTURE.md — 設計方針と判断理由

このドキュメントは、本プロジェクトにおける **重要な設計判断とその理由** をまとめたものです。
新規参加者や AI が設計意図を誤解せず、同じ判断を繰り返さないために記載しています。

---

## 基本方針

* 実プレイ画面から **学習用データを高精度に生成すること** が最優先
* リアルタイム性能よりも「正確さ・再現性・検証可能性」を重視
* 人間が途中で確認・介入できる設計

---

## なぜ per-match JSONL なのか

* 1試合単位でデータの意味が完結する
* 試合途中の中断・失敗が他試合に影響しない
* 学習前処理で試合単位のフィルタ・分割がしやすい

JSONL 形式を採用することで:

* 1行 = 1イベントとしてストリーム処理が可能
* 大規模データでも追記・分割が容易

---

## なぜ画像パスは相対パスなのか

* データセットを別マシン・別環境へコピーしても壊れない
* 学習環境（Python 等）での再配置が容易
* Inspector / Viewer / 学習コードで共通の解決ルールを使える

そのため JSON には常に `frames/...png` のような相対パスを記録する。

---

## なぜ prev / curr の2枚を保存するのか

* 行動は「差分」として現れることが多い
* 単一フレームでは検証できないケースがある
* 学習時に時系列情報を明示的に扱える

prev/curr をセットで保存することで:

* 検証時の視認性が大幅に向上
* モデル設計時に入力形式を柔軟に選べる

---

## なぜ Resolver 方式なのか

* Spell / Unit / 特殊行動など、検出ロジックが増え続ける前提
* if/else の肥大化を避けたい
* 検出器の追加・差し替えを容易にする

Resolver 方式により:

* 各 ActionDetector は独立
* 検出順序・優先度を制御しやすい
* テスト・デバッグが容易

---

## なぜ OpenCV を使わないのか

* 環境構築コストを下げたい
* Windows + .NET 標準で完結させたい
* 将来的な配布・再現性を重視

そのため現段階では System.Drawing を使用し、
必要になった場合のみ段階的な導入を検討する。

---

## 検証ツールを別プロジェクトにしている理由

* Recorder 本体をシンプルに保つ

* 検証・可視化はオフラインで行える

* データ品質チェックを自動化しやすい

* CrDatasetInspector: 機械的チェック

* CrDatasetViewer: 人間による目視確認

---

## 将来の拡張ポイント

* 学習用前処理（Python）との連携
* ActionDetector の精度改善
* Viewer のズーム・クロップ・注釈強化
* モデル推論結果のオーバーレイ表示

---

この設計方針は「途中で変えてはいけない不変条件」ではありませんが、
**変更する場合は必ず理由と影響範囲を明示する**ことを原則とします。
